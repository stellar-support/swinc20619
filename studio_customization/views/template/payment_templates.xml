<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Checkout feedback Payment Form -->
    <template id="stellar_form">
        <input type="hidden" name="data_set" t-att-data-action-url="tx_url" data-remove-me=""/>
        <t t-if="return_url">
            <input type="hidden" name='return_url' t-att-value='return_url'/>
        </t>
        <input type="hidden" name='reference' t-att-value='reference'/>
        <input type="hidden" name='amount' t-att-value='amount'/>
        <input type="hidden" name='currency' t-att-value='currency.name'/>
        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
    </template>

    <!-- Checkout Acquirers-->
    <template id="payment" inherit_id="website_sale.payment">
        <!-- Filter the payments in checkout-->
        <xpath expr="//div[@id='payment_method']" position="before">
            <t t-set="is_public" t-value="request.env.user._is_public()" />
            <t t-if="acquirers" t-set="acquirers" t-value="list(filter(lambda p: p.provider != 'stellar' or not is_public, acquirers))" />
        </xpath>
        <!-- Set new order.pertner_note field -->
        <xpath expr="//div[@id='payment_method']/t[@t-call='payment.payment_tokens_list']" position="inside">
            <t t-set="stellar_entries">
                <h3 class="my-3">Client notes</h3>
                <textarea id='partner_note' class="form-control" rows="6" placeholder="Notes for the order ..."><t t-if='order' t-esc='order.partner_note' /></textarea>
            </t>
        </xpath>
        <!-- Set new order.pertner_note field -->
        <xpath expr="//div[@id='payment_method']" position="attributes">
            <attribute name='class' add='mb-3' separator=' ' />
        </xpath>
        <!-- Change Pay with text -->
        <xpath expr="//div[@id='payment_method']/h3[hasclass('mb24')]" position="replace">
            <h3 class="mb24">Continue With </h3>
        </xpath>
        <!-- Change Pay Now text -->
        <xpath expr="//div[@id='payment_method']/t[@t-call='payment.payment_tokens_list']/t[@t-set='submit_txt']" position="replace">
            <t t-set="submit_txt">Place Order</t>
        </xpath>
    </template>

    <!-- Portal Orders Acquirers -->
    <template id="sale_order_portal_template" inherit_id="sale.sale_order_portal_template">
        <!-- Filter the payment methods in Portal/My orders-->
        <xpath expr="//div[@id='payment_method']" position="before">
            <t t-if="acquirers" t-set="acquirers" t-value="acquirers.filtered(lambda p: p.provider != 'stellar')"  />
        </xpath>
        <!-- Hide pending message when order is confirmed -->
        <xpath expr="//t[@t-if='sale_order.transaction_ids']/t[@ t-call='payment.payment_confirmation_status']/.." position="attributes">
            <attribute name='t-if' add=" and ( sale_order.state != 'sale' or sale_order.get_portal_last_transaction().state != 'pending' ) " separator=' '/>
        </xpath>

    </template>

    <!-- Portal Invoices Acquirers -->
    <template id="payment_tokens_list" inherit_id="payment.payment_tokens_list">
        <!-- Hide stellar payment in Portal-My invoices-->
        <xpath expr="//form[@t-if='pms or acquirers' and  hasclass('o_payment_form')]" position="before">
            <t t-if="invoice and acquirers" t-set="acquirers" t-value="acquirers.filtered(lambda p: p.provider != 'stellar')" />
        </xpath>
        <!-- Render stellar_entries, from  stellar.payment -->
        <xpath expr="//form[hasclass('o_payment_form')]/div[hasclass('card')]" position="after">
            <t t-if="stellar_entries" t-raw="stellar_entries"/>
        </xpath>
    </template>

    <!-- Checkout Confirmation -->
    <template id="payment_confirmation_status" inherit_id="website_sale.payment_confirmation_status">
         <!-- Show post_msg mensaje when stellar pending -->
        <!-- <xpath expr='//div[hasclass("oe_website_sale_tx_status")]/div[1]/ //div[@t-if="payment_tx_id.acquirer_id.post_msg"]/t[@t-raw="payment_tx_id.acquirer_id.post_msg"]' position="attributes">
            <attribute name='t-if'>payment_tx_id.acquirer_id.provider != 'stellar' or payment_tx_id.state == 'pending'</attribute>
        </xpath> -->

        <xpath expr='//div[hasclass("card-header")]' position="before">
            <!-- Show error mensaje when stellar fails -->
            <t t-esc="payment_tx_id.state_message" t-if="payment_tx_id.state_message and payment_tx_id.acquirer_id.provider == 'stellar' and payment_tx_id.state == 'error' "/>
            <!-- Show post_msg mensaje when stellar pending -->
            <div t-if="payment_tx_id.acquirer_id.provider == 'stellar' and order.reference and payment_tx_id.state == 'pending'">
                <p><b>Communication: </b><span t-esc="order.reference"/></p>
                To view your order, please checkout “My Account” section
            </div>
        </xpath>
    </template>

    <!-- Portal Confirmation -->
    <template id="payment_tx_confirmation_status" inherit_id="payment.payment_confirmation_status">
         <!-- Add reference in stellar -->
        <div t-if="thanks_msg and payment_tx_id.acquirer_id.provider == 'transfer' and reference" position="attributes">
            <attribute name='t-if'>thanks_msg and ( payment_tx_id.acquirer_id.provider == 'transfer' or payment_tx_id.acquirer_id.provider == 'stellar') and reference</attribute>
        </div>
    </template>

    <template id="confirmation" inherit_id="website_sale.confirmation">
        <!-- Change Payment Confirmation text -->
        <xpath expr='//div[hasclass("oe_cart")]//h3[hasclass("text-left","mt-3")]/strong' position="replace">
            <strong>Order Information:</strong>
        </xpath>
        
    </template>

</odoo>
